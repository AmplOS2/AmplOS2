S {
        !aarch64-none-elf-g++ -ffreestanding -nostdinc -nostdinc++ -nostdlib -nostartfiles -c src/_start.S -g -o src/_start.o
}

cpp {
        %SET CPPC aarch64-none-elf-g++
        %APPEND CPPFLAGS -Wno-ignored-qualifiers -Wno-unused-function -ffreestanding -nostdinc -nostdinc++ -nostdlib -nostartfiles -c
        %CPPC src/main.o src/main.cpp
        %CPPC src/mbox.o src/mbox.cpp
}

link {
        !aarch64-none-elf-ld -T src/linker.ld -o anos.elf src/*.o
}

objcopy {
        !aarch64-none-elf-objcopy anos.elf -O binary kernel8.img
}

clean {
        !rm -f anos.elf src/*.o
}

all (S cpp link objcopy clean) {}

test (all) {
        # Currently the display is disabled, but once we have a UI,
        # we might want to re-enable it.
        # Append -s and -S to be able to use gdb
        !qemu-system-aarch64 -M raspi3 -serial stdio -kernel kernel8.img
}
